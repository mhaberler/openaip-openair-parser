const Parser = require('../src/parser');

describe('test parse complete airspace definition blocks', () => {
    test('handle ignored lines', async () => {
        const openairParser = new Parser();
        await openairParser.parse('./tests/fixtures/ignored-only.txt');
        const geojson = openairParser.toGeojson();

        expect(geojson.features.length).toEqual(0);
    });
    test('handle inline comments', async () => {
        const openairParser = new Parser();
        await openairParser.parse('./tests/fixtures/airspace-inline-comments.txt');
        const geojson = openairParser.toGeojson();

        const expectedJson = {
            type: 'FeatureCollection',
            features: [
                {
                    type: 'Feature',
                    properties: {
                        name: 'TMP JSDF X-12-2 till 31Mar22 Height by NOTAM',
                        class: 'R',
                        upperCeiling: {
                            value: 240,
                            unit: 'FL',
                            referenceDatum: 'STD',
                        },
                        lowerCeiling: {
                            value: 0,
                            unit: 'FT',
                            referenceDatum: 'GND',
                        },
                    },
                    geometry: {
                        type: 'Polygon',
                        coordinates: [
                            [
                                [133.6638888888889, 36.38444444444444],
                                [133.6638888888889, 36.20666666666667],
                                [132.83944444444447, 35.87972222222222],
                                [132.76333333333332, 36.265],
                                [132.67749999999998, 36.52055555555555],
                                [133.6638888888889, 36.38444444444444],
                            ],
                        ],
                    },
                },
            ],
        };
        // remove feature id for comparison
        geojson.features.map((value) => delete value.id);

        expect(geojson).toEqual(expectedJson);
    });
    test('parse airspace with simple polygon geometry', async () => {
        const openairParser = new Parser();
        await openairParser.parse('./tests/fixtures/polygon-airspace.txt');
        const geojson = openairParser.toGeojson();

        const expectedJson = {
            type: 'FeatureCollection',
            features: [
                {
                    type: 'Feature',
                    properties: {
                        name: 'ED-R10B Todendorf-Putlos MON-SAT+',
                        class: 'R',
                        upperCeiling: {
                            value: 40000,
                            unit: 'FT',
                            referenceDatum: 'MSL',
                        },
                        lowerCeiling: {
                            value: 0,
                            unit: 'FT',
                            referenceDatum: 'GND',
                        },
                    },
                    geometry: {
                        type: 'Polygon',
                        coordinates: [
                            [
                                [10.666666666666666, 54.416666666666664],
                                [10.833333333333334, 54.416666666666664],
                                [10.883333333333333, 54.43333333333333],
                                [10.883333333333333, 54.325],
                                [10.683333333333334, 54.25],
                                [10.666666666666666, 54.25527777777778],
                                [10.666666666666666, 54.333333333333336],
                                [10.666666666666666, 54.416666666666664],
                            ],
                        ],
                    },
                },
            ],
        };
        // remove feature id for comparison
        geojson.features.map((value) => delete value.id);

        expect(geojson).toEqual(expectedJson);
    });
    test('parse airspace with circular geometry', async () => {
        const openairParser = new Parser();
        await openairParser.parse('./tests/fixtures/circular-airspace.txt');
        const geojson = openairParser.toGeojson();

        const expectedJson = {
            type: 'FeatureCollection',
            features: [
                {
                    type: 'Feature',
                    // IMPORTANT feature Id value changes every time => remove for comparison
                    // id: 'da2c17bf-cef1-4460-972d-572087e40edd',
                    properties: {
                        name: 'ED-R3 Geesthacht H24',
                        class: 'R',
                        upperCeiling: {
                            value: 2200,
                            unit: 'FT',
                            referenceDatum: 'MSL',
                        },
                        lowerCeiling: {
                            value: 0,
                            unit: 'FT',
                            referenceDatum: 'GND',
                        },
                    },
                    geometry: {
                        type: 'Polygon',
                        coordinates: [
                            [
                                [10.419444444444444, 53.425265398894226],
                                [10.417513856061632, 53.425229231113505],
                                [10.415590896649324, 53.425120870693235],
                                [10.413683164914845, 53.42494074583215],
                                [10.411798199161039, 53.424689568307244],
                                [10.409943447388256, 53.424368330650445],
                                [10.408126237759891, 53.423978302211665],
                                [10.406353749550334, 53.423521024124554],
                                [10.404632984692013, 53.422998303194774],
                                [10.402970740035723, 53.42241220473559],
                                [10.401373580435395, 53.421765044379555],
                                [10.39984781276498, 53.42105937889916],
                                [10.39839946097114, 53.420297996073394],
                                [10.397034242261128, 53.41948390364081],
                                [10.395757544520418, 53.418620317383414],
                                [10.394574405049493, 53.417710648389246],
                                [10.393489490703729, 53.416758489544385],
                                [10.392507079514411, 53.415767601308765],
                                [10.391631043862784, 53.41474189683237],
                                [10.390864835272643, 53.41368542647132],
                                [10.390211470880299, 53.4126023617656],
                                [10.389673521633815, 53.411496978942324],
                                [10.389253102266473, 53.41037364200995],
                                [10.388951863082056, 53.4092367855109],
                                [10.388770983582365, 53.40809089700086],
                                [10.38871116795986, 53.406940499324264],
                                [10.388772642470888, 53.40579013275609],
                                [10.388955154697452, 53.404644337080775],
                                [10.389257974698042, 53.403507633678686],
                                [10.389679898040448, 53.40238450769107],
                                [10.390219250702316, 53.401279390333606],
                                [10.390873895817679, 53.400196641428245],
                                [10.3916412422407, 53.399140532221715],
                                [10.392518254890767, 53.39811522855839],
                                [10.393501466836234, 53.39712477447334],
                                [10.394586993067437, 53.39617307626972],
                                [10.395770545903282, 53.39526388714288],
                                [10.397047451969366, 53.39440079241113],
                                [10.398412670679768, 53.39358719541083],
                                [10.399860814148997, 53.39282630411075],
                                [10.401386168455177, 53.39212111849776],
                                [10.402982716170639, 53.391474418783076],
                                [10.404644160071202, 53.39088875447459],
                                [10.406363947931323, 53.39036643435803],
                                [10.408135298308052, 53.38990951742559],
                                [10.409951227213254, 53.38951980478731],
                                [10.411804575570319, 53.38919883259646],
                                [10.413688037348557, 53.38894786601645],
                                [10.41559418826623, 53.3887678942524],
                                [10.417515514950932, 53.38865962666691],
                                [10.419444444444444, 53.38862348999464],
                                [10.421373373937959, 53.38865962666691],
                                [10.42329470062266, 53.3887678942524],
                                [10.425200851540335, 53.38894786601645],
                                [10.427084313318574, 53.38919883259646],
                                [10.428937661675636, 53.38951980478731],
                                [10.43075359058084, 53.38990951742559],
                                [10.432524940957567, 53.39036643435803],
                                [10.434244728817688, 53.39088875447459],
                                [10.435906172718253, 53.391474418783076],
                                [10.437502720433713, 53.39212111849776],
                                [10.439028074739895, 53.39282630411075],
                                [10.44047621820912, 53.39358719541083],
                                [10.441841436919525, 53.39440079241113],
                                [10.443118342985608, 53.39526388714288],
                                [10.444301895821456, 53.39617307626972],
                                [10.445387422052658, 53.39712477447334],
                                [10.446370633998121, 53.39811522855839],
                                [10.447247646648192, 53.399140532221715],
                                [10.448014993071213, 53.400196641428245],
                                [10.448669638186574, 53.401279390333606],
                                [10.44920899084844, 53.40238450769107],
                                [10.44963091419085, 53.403507633678686],
                                [10.449933734191436, 53.404644337080775],
                                [10.450116246418004, 53.40579013275609],
                                [10.45017772092903, 53.406940499324264],
                                [10.450117905306527, 53.40809089700086],
                                [10.449937025806836, 53.4092367855109],
                                [10.449635786622418, 53.41037364200995],
                                [10.449215367255077, 53.411496978942324],
                                [10.448677418008593, 53.4126023617656],
                                [10.448024053616246, 53.41368542647132],
                                [10.447257845026108, 53.41474189683237],
                                [10.446381809374477, 53.415767601308765],
                                [10.445399398185163, 53.416758489544385],
                                [10.444314483839399, 53.417710648389246],
                                [10.443131344368473, 53.418620317383414],
                                [10.441854646627762, 53.41948390364081],
                                [10.440489427917752, 53.420297996073394],
                                [10.43904107612391, 53.42105937889916],
                                [10.437515308453497, 53.421765044379555],
                                [10.435918148853169, 53.42241220473559],
                                [10.43425590419688, 53.422998303194774],
                                [10.432535139338558, 53.423521024124554],
                                [10.430762651129001, 53.423978302211665],
                                [10.428945441500636, 53.424368330650445],
                                [10.42709068972785, 53.424689568307244],
                                [10.425205723974047, 53.42494074583215],
                                [10.423297992239565, 53.425120870693235],
                                [10.421375032827259, 53.425229231113505],
                                [10.419444444444444, 53.425265398894226],
                            ],
                        ],
                    },
                },
            ],
        };
        // remove feature id for comparison
        geojson.features.map((value) => delete value.id);

        expect(geojson).toEqual(expectedJson);
    });
    test('parse laser beam airspace with very small circular geometry', async () => {
        const openairParser = new Parser();
        await openairParser.parse('./tests/fixtures/laser-beam-airspace.txt');
        const geojson = openairParser.toGeojson();

        const expectedJson = {
            type: 'FeatureCollection',
            features: [
                {
                    type: 'Feature',
                    properties: {
                        name: 'Lampedusa(LaserBeam)',
                        class: 'Q',
                        upperCeiling: {
                            value: 999,
                            unit: 'FL',
                            referenceDatum: 'STD',
                        },
                        lowerCeiling: {
                            value: 0,
                            unit: 'FT',
                            referenceDatum: 'GND',
                        },
                    },
                    geometry: {
                        type: 'Polygon',
                        coordinates: [
                            [
                                [12.630555555555556, 35.51836014854849],
                                [12.630553486897876, 35.51836009563477],
                                [12.630551426404253, 35.518359937102424],
                                [12.63054938220652, 35.518359673577145],
                                [12.630547362372198, 35.518359306098915],
                                [12.630545374872659, 35.518358836118004],
                                [12.630543427551661, 35.51835826548923],
                                [12.630541528094403, 35.518357596464604],
                                [12.63053968399717, 35.51835683168446],
                                [12.630537902537785, 35.51835597416702],
                                [12.630536190746854, 35.51835502729655],
                                [12.630534555380038, 35.5183539948099],
                                [12.630533002891385, 35.51835288078182],
                                [12.63053153940786, 35.51835168960888],
                                [12.630530170705162, 35.5183504259921],
                                [12.630528902184935, 35.5183490949184],
                                [12.630527738853448, 35.51834770164093],
                                [12.630526685301833, 35.518346251658315],
                                [12.630525745687976, 35.51834475069297],
                                [12.630524923720097, 35.51834320466855],
                                [12.630524222642123, 35.51834161968647],
                                [12.630523645220883, 35.518340002001956],
                                [12.630523193735186, 35.518338357999276],
                                [12.630522869966834, 35.51833669416654],
                                [12.630522675193582, 35.518335017070164],
                                [12.630522610184107, 35.51833333332885],
                                [12.630522675194964, 35.51833164958757],
                                [12.630522869969571, 35.5183299724913],
                                [12.630523193739238, 35.51832830865875],
                                [12.630523645226186, 35.5183266646563],
                                [12.630524222648594, 35.518325046972095],
                                [12.63052492372763, 35.51832346199038],
                                [12.630525745696456, 35.51832191596636],
                                [12.630526685311127, 35.51832041500147],
                                [12.630527738863407, 35.51831896501935],
                                [12.630528902195401, 35.51831757174241],
                                [12.630530170715973, 35.51831624066925],
                                [12.630531539418843, 35.51831497705302],
                                [12.630533002902371, 35.51831378588064],
                                [12.630534555390849, 35.51831267185313],
                                [12.630536190757322, 35.51831163936702],
                                [12.630537902547744, 35.51831069249707],
                                [12.630539684006463, 35.51830983498013],
                                [12.630541528102881, 35.51830907020044],
                                [12.630543427559196, 35.51830840117622],
                                [12.630545374879127, 35.5183078305478],
                                [12.630547362377499, 35.5183073605672],
                                [12.63054938221057, 35.51830699308921],
                                [12.63055142640699, 35.518306729564095],
                                [12.630553486899258, 35.518306571031864],
                                [12.630555555555556, 35.51830651811819],
                                [12.630557624211857, 35.518306571031864],
                                [12.630559684704123, 35.518306729564095],
                                [12.630561728900544, 35.51830699308921],
                                [12.630563748733614, 35.5183073605672],
                                [12.630565736231986, 35.5183078305478],
                                [12.630567683551917, 35.51830840117622],
                                [12.630569583008231, 35.51830907020044],
                                [12.630571427104652, 35.51830983498013],
                                [12.63057320856337, 35.51831069249707],
                                [12.630574920353792, 35.51831163936702],
                                [12.630576555720264, 35.51831267185313],
                                [12.630578108208745, 35.51831378588064],
                                [12.630579571692271, 35.51831497705302],
                                [12.63058094039514, 35.51831624066925],
                                [12.630582208915712, 35.51831757174241],
                                [12.630583372247708, 35.51831896501935],
                                [12.630584425799988, 35.51832041500147],
                                [12.630585365414657, 35.51832191596636],
                                [12.630586187383482, 35.51832346199038],
                                [12.63058688846252, 35.518325046972095],
                                [12.630587465884927, 35.5183266646563],
                                [12.630587917371875, 35.51832830865875],
                                [12.630588241141544, 35.5183299724913],
                                [12.630588435916149, 35.51833164958757],
                                [12.630588500927006, 35.51833333332885],
                                [12.63058843591753, 35.518335017070164],
                                [12.630588241144281, 35.51833669416654],
                                [12.630587917375927, 35.518338357999276],
                                [12.63058746589023, 35.518340002001956],
                                [12.63058688846899, 35.51834161968647],
                                [12.630586187391016, 35.51834320466855],
                                [12.630585365423137, 35.51834475069297],
                                [12.63058442580928, 35.518346251658315],
                                [12.630583372257668, 35.51834770164093],
                                [12.630582208926178, 35.5183490949184],
                                [12.63058094040595, 35.5183504259921],
                                [12.630579571703253, 35.51835168960888],
                                [12.630578108219728, 35.51835288078182],
                                [12.630576555731075, 35.5183539948099],
                                [12.630574920364259, 35.51835502729655],
                                [12.630573208573328, 35.51835597416702],
                                [12.630571427113942, 35.51835683168446],
                                [12.630569583016714, 35.518357596464604],
                                [12.630567683559452, 35.51835826548923],
                                [12.630565736238454, 35.518358836118004],
                                [12.630563748738915, 35.518359306098915],
                                [12.630561728904594, 35.518359673577145],
                                [12.63055968470686, 35.518359937102424],
                                [12.630557624213237, 35.51836009563477],
                                [12.630555555555556, 35.51836014854849],
                            ],
                        ],
                    },
                },
            ],
        };
        // remove feature id for comparison
        geojson.features.map((value) => delete value.id);

        expect(geojson).toEqual(expectedJson);
    });
    test('parse airspace with clockwise arc geometry', async () => {
        const openairParser = new Parser();
        await openairParser.parse('./tests/fixtures/arc-clockwise-airspace.txt');
        const geojson = openairParser.toGeojson();

        const expectedJson = {
            type: 'FeatureCollection',
            features: [
                {
                    type: 'Feature',
                    // IMPORTANT feature Id value changes every time => remove for comparison
                    // id: '2c2880a0-c908-4b73-af43-5ac440b82fe2',
                    properties: {
                        name: 'ED-R56 Kummersdorf MON-FRI',
                        class: 'R',
                        upperCeiling: {
                            value: 3500,
                            unit: 'FT',
                            referenceDatum: 'MSL',
                        },
                        lowerCeiling: {
                            value: 0,
                            unit: 'FT',
                            referenceDatum: 'GND',
                        },
                    },
                    geometry: {
                        type: 'Polygon',
                        coordinates: [
                            [
                                [13.392777777777777, 52.126666666666665],
                                [13.418888888888889, 52.1325],
                                [13.41888888888889, 52.1325],
                                [13.42130306051576, 52.1329895361755],
                                [13.42376259017737, 52.13338500635156],
                                [13.426257756627397, 52.13368484726553],
                                [13.428778697061437, 52.13388787364201],
                                [13.431315446286261, 52.13399328290128],
                                [13.433857976303763, 52.13400065834767],
                                [13.436396236149374, 52.133909970825],
                                [13.438920191823492, 52.133721578832514],
                                [13.441419866154195, 52.13343622710048],
                                [13.443885378429728, 52.13305504363173],
                                [13.44630698364028, 52.132579535220536],
                                [13.448675111170244, 52.13201158146763],
                                [13.450980402784642, 52.13135342731493],
                                [13.45321374975627, 52.13060767413072],
                                [13.45536632898408, 52.12977726938105],
                                [13.45742963795751, 52.128865494929215],
                                [13.459395528426471, 52.12787595401042],
                                [13.4612562386424, 52.126812556934475],
                                [13.463004424041742, 52.12567950557393],
                                [13.464633186250005, 52.12448127670013],
                                [13.46613610029165, 52.12322260423443],
                                [13.467507239898643, 52.12190846048569],
                                [13.468741200818615, 52.12054403644945],
                                [13.469833122031865, 52.11913472124779],
                                [13.470778704795304, 52.11768608079215],
                                [13.471574229440366, 52.116203835754234],
                                [13.47221656986127, 52.11469383893336],
                                [13.472703205639505, 52.113162052109935],
                                [13.47303223176004, 52.1116145224775],
                                [13.473202365884573, 52.110057358746964],
                                [13.473212953156994, 52.10849670701751],
                                [13.473063968526125, 52.106938726510215],
                                [13.47275601658072, 52.10538956525981],
                                [13.472290328901481, 52.10385533586084],
                                [13.47166875894477, 52.10234209136373],
                                [13.470893774482105, 52.100855801415406],
                                [13.469968447629268, 52.09940232873846],
                                [13.468896442507948, 52.09798740604074],
                                [13.467682000591953, 52.096616613446],
                                [13.466329923798925, 52.09529535653376],
                                [13.464845555396888, 52.09402884507396],
                                [13.463234758803189, 52.09282207253925],
                                [13.461503894361346, 52.09167979647492],
                                [13.459659794188664, 52.0906065198023],
                                [13.457709735194715, 52.08960647312848],
                                [13.455661410377452, 52.08868359813076],
                                [13.453522898509938, 52.087841532080155],
                                [13.451302632336613, 52.08708359356387],
                                [13.44900936540335, 52.08641276946172],
                                [13.446665810329549, 52.08583477278266],
                                [13.446666666666667, 52.08583333333333],
                                [13.420555555555556, 52.080000000000005],
                                [13.420555555555556, 52.08],
                                [13.418144107101925, 52.079510347728736],
                                [13.41568743484834, 52.07911466594883],
                                [13.413195219601796, 52.07881451371908],
                                [13.410677281530655, 52.07861107366669],
                                [13.408143541652363, 52.0785051473506],
                                [13.405603982933657, 52.07849715211877],
                                [13.403068611152772, 52.07858711947217],
                                [13.400547415673998, 52.078774694941245],
                                [13.398050330285315, 52.079059139475554],
                                [13.395587194249517, 52.07943933234118],
                                [13.39316771371857, 52.079913775514875],
                                [13.390801423659592, 52.080480599557895],
                                [13.388497650439126, 52.081137570947064],
                                [13.386265475209939, 52.08188210083487],
                                [13.38411369824184, 52.08271125520473],
                                [13.382050804334614, 52.08362176638256],
                                [13.380084929447257, 52.084610045860025],
                                [13.378223828673466, 52.08567219838021],
                                [13.376474845688389, 52.08680403723114],
                                [13.37484488378639, 52.08800110068828],
                                [13.37334037862379, 52.08925866954211],
                                [13.371967272774393, 52.090571785643114],
                                [13.370730992198835, 52.091935271391996],
                                [13.369636424721946, 52.09334375009982],
                                [13.368687900604655, 52.09479166713833],
                                [13.367889175289328, 52.096273311798605],
                                [13.367243414389232, 52.09778283977243],
                                [13.366753180984274, 52.09931429616867],
                                [13.366420425276523, 52.10086163897456],
                                [13.36624647664992, 52.10241876286996],
                                [13.366232038169338, 52.103979523301135],
                                [13.366377183544717, 52.10553776071923],
                                [13.366681356576375, 52.10708732488817],
                                [13.367143373087805, 52.10862209916584],
                                [13.367761425342541, 52.110136024662914],
                                [13.368533088931656, 52.111623124183275],
                                [13.369455332108625, 52.11307752585144],
                                [13.37052452753841, 52.11449348633292],
                                [13.371736466417834, 52.11586541355545],
                                [13.373086374914568, 52.11718788883997],
                                [13.374568932862623, 52.11845568835375],
                                [13.376178294642832, 52.11966380379944],
                                [13.377908112167779, 52.12080746225737],
                                [13.379751559881802, 52.12188214510163],
                                [13.381701361678296, 52.12288360591405],
                                [13.383749819628392, 52.12380788732388],
                                [13.385888844407432, 52.124651336705746],
                                [13.388109987298469, 52.1254106206724],
                                [13.390404473645217, 52.12608273830403],
                                [13.392763237620747, 52.12666503306055],
                                [13.392776920473388, 52.12666810613394],
                                [13.392777777777777, 52.126666666666665],
                            ],
                        ],
                    },
                },
            ],
        };
        // remove feature id for comparison
        geojson.features.map((value) => delete value.id);

        expect(geojson).toEqual(expectedJson);
    });
    test('parse airspace with counter-clockwise arc geometry', async () => {
        const openairParser = new Parser();
        await openairParser.parse('./tests/fixtures/arc-counterclockwise-airspace.txt');
        const geojson = openairParser.toGeojson();

        const expectedJson = {
            type: 'FeatureCollection',
            features: [
                {
                    type: 'Feature',
                    properties: {
                        name: 'ED-R37B_2 Nordhorn NOTAM',
                        class: 'R',
                        upperCeiling: {
                            value: 100,
                            unit: 'FL',
                            referenceDatum: 'STD',
                        },
                        lowerCeiling: {
                            value: 4000,
                            unit: 'FT',
                            referenceDatum: 'MSL',
                        },
                    },
                    geometry: {
                        type: 'Polygon',
                        coordinates: [
                            [
                                [7.063611111111111, 52.7175],
                                [7.252777777777778, 52.68333333333333],
                                [7.296666666666667, 52.49194444444444],
                                [7.296542956171171, 52.491869586055905],
                                [7.293395896926528, 52.49373637199246],
                                [7.286985276535472, 52.49719249589972],
                                [7.2802298709794, 52.5003963576714],
                                [7.273156387291307, 52.50333525667796],
                                [7.265792810750007, 52.50599754019928],
                                [7.258168293344321, 52.508372650272996],
                                [7.250313037284236, 52.51045116617362],
                                [7.242258174041408, 52.512224842342206],
                                [7.234035639424305, 52.51368664160448],
                                [7.225678045213872, 52.51483076353597],
                                [7.2172185479033315, 52.515652667852116],
                                [7.2086907151010475, 52.51614909272359],
                                [7.200128390167527, 52.51631806793777],
                                [7.191565555667009, 52.51615892285001],
                                [7.183036196220349, 52.51567228909044],
                                [7.174574161349032, 52.514860098014644],
                                [7.166213028900287, 52.513725572909145],
                                [7.157985969640083, 52.51227321598536],
                                [7.149925613594699, 52.510508790217784],
                                [7.14206391871233, 52.50843929610446],
                                [7.13443204240395, 52.50607294344948],
                                [7.127060216507661, 52.50341911828812],
                                [7.1199776262028935, 52.50048834509631],
                                [7.113212293380457, 52.497292244445156],
                                [7.10679096495152, 52.49384348628092],
                                [7.100739006553542, 52.49015573902836],
                                [7.095080302083937, 52.48624361473263],
                                [7.089837159463189, 52.482122610470924],
                                [7.08503022299845, 52.477809046279546],
                                [7.080678392686481, 52.473319999856045],
                                [7.076798750761442, 52.468673238308156],
                                [7.073406495758753, 52.46388714723237],
                                [7.0705148843310965, 52.45898065741479],
                                [7.06813518101714, 52.45397316945506],
                                [7.066276616127524, 52.44888447662137],
                                [7.064946351876799, 52.443734686250004],
                                [7.06414945685398, 52.438544140007096],
                                [7.06388888888889, 52.43333333333333],
                                [7.063888888888889, 52.43333333333333],
                                [7.060833333333333, 52.43333333333333],
                                [7.057777777777778, 52.653055555555554],
                                [7.063611111111111, 52.7175],
                            ],
                        ],
                    },
                },
            ],
        };
        // remove feature id for comparison
        geojson.features.map((value) => delete value.id);

        expect(geojson).toEqual(expectedJson);
    });
    test('parse airspace with arc/angle geometry', async () => {
        const openairParser = new Parser();
        await openairParser.parse('./tests/fixtures/arc-angle-airspace.txt');
        const geojson = openairParser.toGeojson();

        const expectedJson = {
            type: 'FeatureCollection',
            features: [
                {
                    type: 'Feature',
                    properties: {
                        name: 'San Rocco al Porto Corridor(ULM)',
                        class: 'R',
                        upperCeiling: {
                            value: 500,
                            unit: 'FT',
                            referenceDatum: 'GND',
                        },
                        lowerCeiling: {
                            value: 0,
                            unit: 'FT',
                            referenceDatum: 'GND',
                        },
                    },
                    geometry: {
                        type: 'Polygon',
                        coordinates: [
                            [
                                [9.661388888888888, 45.09305555555556],
                                [9.680051597337565, 45.11365657908377],
                                [9.680263123285682, 45.113871383891876],
                                [9.680493345958448, 45.1140763913863],
                                [9.680741356845196, 45.11427079238629],
                                [9.68100617719373, 45.11445381956779],
                                [9.68128676187248, 45.11462475049333],
                                [9.681582003495263, 45.114782910465074],
                                [9.681890736792361, 45.11492767518924],
                                [9.682211743210674, 45.11505847324162],
                                [9.68254375572473, 45.11517478832436],
                                [9.682885463839588, 45.11527616130515],
                                [9.683235518765803, 45.11536219203053],
                                [9.683592538746014, 45.11543254090651],
                                [9.683955114512056, 45.115486930239726],
                                [9.684321814851012, 45.11552514533448],
                                [9.684691192258166, 45.11554703534065],
                                [9.685061788654465, 45.115552513849565],
                                [9.685432141145865, 45.11554155923531],
                                [9.685800787801746, 45.11551421474022],
                                [9.68616627342951, 45.11547058830396],
                                [9.686527155322482, 45.115410852137224],
                                [9.686882008958397, 45.115335242041546],
                                [9.687229433625836, 45.11524405647784],
                                [9.6875680579564, 45.11513765538759],
                                [9.687896545340697, 45.115016458771095],
                                [9.688213599206696, 45.114880945028645],
                                [9.68851796813958, 45.11473164907106],
                                [9.688808450822847, 45.11456916020697],
                                [9.689083900781114, 45.114394119815486],
                                [9.689343230905873, 45.11420721881327],
                                [9.689585417746352, 45.11400919492591],
                                [9.689809505548482, 45.11380082977483],
                                [9.6900146100261, 45.11358294579067],
                                [9.690199921849453, 45.11335640296597],
                                [9.690364709837304, 45.113122095459396],
                                [9.69050832384004, 45.112880948065474],
                                [9.690630197302475, 45.112633912563346],
                                [9.690729849496249, 45.1123819639593],
                                [9.690806887413089, 45.11212609663781],
                                [9.690861007311534, 45.111867320436104],
                                [9.690891995911038, 45.111606656658246],
                                [9.690899731228876, 45.11134513404384],
                                [9.690884183056594, 45.111083784707866],
                                [9.690845413074168, 45.1108236400673],
                                [9.69078357460158, 45.11056572677072],
                                [9.690698911988793, 45.11031106264699],
                                [9.690591759646665, 45.11006065268888],
                                [9.69046254072266, 45.109815485087694],
                                [9.690311765426687, 45.10957652733425],
                                [9.690140029013728, 45.1093447224018],
                                [9.671388888888888, 45.08861111111111],
                                [9.671335117346947, 45.088565429546996],
                                [9.671123648712147, 45.08835064261057],
                                [9.67089349657686, 45.08814565367993],
                                [9.670645569319241, 45.08795127164303],
                                [9.670380845428216, 45.08776826352492],
                                [9.670100369641307, 45.0875973514624],
                                [9.669805248821627, 45.087439209855816],
                                [9.66949664759035, 45.08729446270932],
                                [9.669175783731824, 45.08716368116994],
                                [9.668843923389492, 45.08704738127508],
                                [9.668502376071519, 45.08694602191754],
                                [9.668152489485806, 45.08686000303592],
                                [9.66779564422471, 45.086789664037475],
                                [9.66743324832045, 45.08673528245973],
                                [9.667066731692515, 45.0866970728761],
                                [9.666697540509055, 45.08667518604981],
                                [9.666327131484314, 45.08666970833937],
                                [9.66595696613461, 45.086680661358066],
                                [9.665588505015428, 45.086708001888795],
                                [9.665223201962286, 45.08675162205437],
                                [9.664862498358033, 45.086811349742995],
                                [9.664507817449126, 45.08688694928686],
                                [9.664160558733219, 45.086978122391415],
                                [9.663822092440197, 45.087084509311715],
                                [9.663493754128307, 45.087205690270906],
                                [9.663176839416675, 45.087341187115605],
                                [9.66287259887498, 45.08749046520152],
                                [9.662582233090351, 45.08765293550183],
                                [9.662306887930951, 45.0878279569302],
                                [9.66204765002492, 45.088014838869036],
                                [9.661805542472466, 45.08821284389338],
                                [9.66158152080806, 45.088421190679306],
                                [9.661376469228642, 45.088639057085786],
                                [9.66119119710275, 45.0888655833975],
                                [9.661026435774362, 45.08909987571619],
                                [9.6608828356741, 45.089341009486866],
                                [9.660760963749246, 45.08958803314521],
                                [9.660661301222719, 45.08983997187173],
                                [9.660584241689989, 45.090095831437765],
                                [9.66053008956142, 45.09035460212832],
                                [9.660499058856296, 45.090615262726324],
                                [9.660491272353376, 45.09087678454228],
                                [9.660506761101388, 45.09113813547378],
                                [9.660545464291438, 45.0913982840787],
                                [9.660607229492003, 45.09165620364596],
                                [9.660691813245565, 45.09191087624781],
                                [9.66079888202469, 45.09216129675774],
                                [9.66092801354377, 45.09240647681807],
                                [9.661078698421429, 45.09264544874148],
                                [9.661250342186975, 45.09287726933123],
                                [9.661388888888888, 45.09305555555556],
                            ],
                        ],
                    },
                },
                {
                    type: 'Feature',
                    properties: {
                        name: 'TH-3-1',
                        class: 'G',
                        upperCeiling: {
                            value: 5000,
                            unit: 'FT',
                            referenceDatum: 'MSL',
                        },
                        lowerCeiling: {
                            value: 0,
                            unit: 'FT',
                            referenceDatum: 'GND',
                        },
                    },
                    geometry: {
                        type: 'Polygon',
                        coordinates: [
                            [
                                [141.1336111111111, 39.43333333333333],
                                [140.81015173725802, 39.43506557408456],
                                [140.81014954280303, 39.432885400088495],
                                [140.81086047651263, 39.41720028539311],
                                [140.81284424144212, 39.40158058024574],
                                [140.81609216589638, 39.38608786276914],
                                [140.82059061797182, 39.3707831697238],
                                [140.82632107208644, 39.35572675735563],
                                [140.83326019413178, 39.340977865923364],
                                [140.8413799447276, 39.32659448879638],
                                [140.85064770000076, 39.31263314698693],
                                [140.86102638925902, 39.299148669951876],
                                [140.87247464888304, 39.28619398346713],
                                [140.88494699171733, 39.27381990534445],
                                [140.89839399120234, 39.26207494972471],
                                [140.91276247945515, 39.25100514064398],
                                [140.92799575847744, 39.24065383552988],
                                [140.9440338236405, 39.231061559245454],
                                [140.96081359857573, 39.2222658492557],
                                [140.97826918057774, 39.21430111244953],
                                [140.99633209560997, 39.2071984941063],
                                [141.01493156198848, 39.200985759451086],
                                [141.03399476180624, 39.195687188198264],
                                [141.05344711915072, 39.19132348243709],
                                [141.0732125841581, 39.187911688166224],
                                [141.0932139219419, 39.18546513073834],
                                [141.11337300542613, 39.183993364428176],
                                [141.1336111111111, 39.183502136290656],
                                [141.15384921679603, 39.183993364428176],
                                [141.17400830028024, 39.18546513073834],
                                [141.19400963806405, 39.187911688166224],
                                [141.21377510307144, 39.19132348243709],
                                [141.23322746041592, 39.195687188198264],
                                [141.25229066023368, 39.200985759451086],
                                [141.2708901266122, 39.2071984941063],
                                [141.28895304164442, 39.21430111244953],
                                [141.30640862364643, 39.2222658492557],
                                [141.32318839858166, 39.231061559245454],
                                [141.33922646374472, 39.24065383552988],
                                [141.354459742767, 39.25100514064398],
                                [141.36882823101982, 39.26207494972471],
                                [141.38227523050483, 39.27381990534445],
                                [141.39474757333912, 39.28619398346713],
                                [141.40619583296314, 39.299148669951876],
                                [141.41657452222137, 39.31263314698693],
                                [141.42584227749455, 39.32659448879638],
                                [141.43396202809038, 39.340977865923364],
                                [141.44090115013572, 39.35572675735563],
                                [141.4466316042503, 39.3707831697238],
                                [141.45113005632578, 39.38608786276914],
                                [141.45437798078, 39.40158058024574],
                                [141.45636174570953, 39.41720028539311],
                                [141.45707267941913, 39.432885400088495],
                                [141.1336111111111, 39.43333333333333],
                            ],
                        ],
                    },
                },
            ],
        };
        // remove feature id for comparison
        geojson.features.map((value) => delete value.id);

        expect(geojson).toEqual(expectedJson);
    });
    test('parse airspace starting with arc definition', async () => {
        const openairParser = new Parser();
        await openairParser.parse('./tests/fixtures/arc-first-airspace.txt');
        const geojson = openairParser.toGeojson();

        const expectedJson = {
            type: 'FeatureCollection',
            features: [
                {
                    type: 'Feature',
                    properties: {
                        name: 'JENA 1 0800-2200 MON-FRI and BY NOTAM',
                        class: 'Q',
                        upperCeiling: {
                            value: 5000,
                            unit: 'FT',
                            referenceDatum: 'MSL',
                        },
                        lowerCeiling: {
                            value: 1501,
                            unit: 'FT',
                            referenceDatum: 'GND',
                        },
                    },
                    geometry: {
                        type: 'Polygon',
                        coordinates: [
                            [
                                [-92.65944444444445, 32.01361111111111],
                                [-92.65574348522192, 32.013468001773944],
                                [-92.6520604499446, 32.01312802354682],
                                [-92.64840989719758, 32.012592520349074],
                                [-92.64480625654188, 32.01186360897153],
                                [-92.64126377121202, 32.01094417066854],
                                [-92.63779644156742, 32.00983783971463],
                                [-92.63441796952657, 32.008548988971924],
                                [-92.63114170420826, 32.00708271252674],
                                [-92.62798058899864, 32.00544480546562],
                                [-92.62494711025712, 32.003641740872524],
                                [-92.62205324786693, 32.0016806441399],
                                [-92.61931042782797, 31.999569264697534],
                                [-92.61672947708152, 31.997315945273],
                                [-92.6143205807458, 31.994929588807402],
                                [-92.61209324193204, 31.992419623159737],
                                [-92.61005624429949, 31.989795963741496],
                                [-92.60821761749577, 31.987068974231573],
                                [-92.60658460561788, 31.98424942552895],
                                [-92.60516363881509, 31.981348453107362],
                                [-92.60396030814374, 31.978377512942572],
                                [-92.60297934376847, 31.975348336188055],
                                [-92.60222459659242, 31.97227288277975],
                                [-92.60169902338386, 31.969163294154598],
                                [-92.60140467545264, 31.966031845270653],
                                [-92.60134269091618, 31.9628908961191],
                                [-92.60151329057925, 31.959752842920327],
                                [-92.60191577743821, 31.95663006919687],
                                [-92.6025485398059, 31.95353489691655],
                                [-92.60340905803851, 31.95047953789828],
                                [-92.60449391483255, 31.947476045671706],
                                [-92.60579880904542, 31.944536267979966],
                                [-92.6073185729801, 31.94167180011166],
                                [-92.60904719306056, 31.938893939244988],
                                [-92.6109778338121, 31.93621363998236],
                                [-92.61310286504808, 31.933641471249253],
                                [-92.61541389215252, 31.931187574725318],
                                [-92.61790178933626, 31.92886162496938],
                                [-92.6205567357336, 31.92667279139351],
                                [-92.62336825419573, 31.924629702233894],
                                [-92.62632525262731, 31.922740410657834],
                                [-92.62941606770318, 31.921012363138583],
                                [-92.63262851079377, 31.919452370220032],
                                [-92.63594991591951, 31.918066579784465],
                                [-92.63936718954746, 31.91686045292637],
                                [-92.64286686203631, 31.915838742525583],
                                [-92.64643514053104, 31.9150054746023],
                                [-92.65005796310159, 31.91436393252568],
                                [-92.65372105391751, 31.913916644136965],
                                [-92.6574099792453, 31.913665371836615],
                                [-92.66111020405302, 31.913611105673564],
                                [-92.66480714900435, 31.913754059463223],
                                [-92.6684862476229, 31.914093669949114],
                                [-92.67213300340721, 31.91462859901141],
                                [-92.67573304667668, 31.91535673891378],
                                [-92.67927219092984, 31.91627522056851],
                                [-92.68273648849808, 31.917380424788032],
                                [-92.68611228528057, 31.918667996479545],
                                [-92.68938627434892, 31.920132861728153],
                                [-92.69254554821478, 31.921769247702752],
                                [-92.69557764955773, 31.923570705307892],
                                [-92.69847062021688, 31.925530134494288],
                                [-92.70121304825528, 31.92763981213036],
                                [-92.7037941129137, 31.929891422327056],
                                [-92.70620362727725, 31.93227608909882],
                                [-92.70843207848793, 31.934784411234116],
                                [-92.71047066534325, 31.937406499240602],
                                [-92.71231133313246, 31.94013201422146],
                                [-92.71394680557097, 31.942950208531887],
                                [-92.71537061370496, 31.945849968057676],
                                [-92.71657712166859, 31.948819855951125],
                                [-92.71756154918948, 31.951848157653664],
                                [-92.71831999074865, 31.95492292702943],
                                [-92.71884943131532, 31.95803203342903],
                                [-92.71914775858913, 31.961163209499386],
                                [-92.71921377169623, 31.96430409955174],
                                [-92.71904718629904, 31.967442308297713],
                                [-92.71864863609389, 31.970565449761725],
                                [-92.7180853633086, 31.973385265320758],
                                [-92.71777777777778, 31.973333333333333],
                                [-92.65944444444445, 32.01361111111111],
                            ],
                        ],
                    },
                },
            ],
        };
        // remove feature id for comparison
        geojson.features.map((value) => delete value.id);

        expect(geojson).toEqual(expectedJson);
    });
    test('parse multiple airspace definition blocks', async () => {
        const openairParser = new Parser();
        await openairParser.parse('./tests/fixtures/multiple-airspaces.txt');
        const geojson = openairParser.toGeojson();

        const expectedJson = {
            type: 'FeatureCollection',
            features: [
                {
                    type: 'Feature',
                    properties: {
                        name: 'TMP JSDF X-12-2 till 31Mar22 Height by NOTAM',
                        class: 'R',
                        upperCeiling: {
                            value: 240,
                            unit: 'FL',
                            referenceDatum: 'STD',
                        },
                        lowerCeiling: {
                            value: 0,
                            unit: 'FT',
                            referenceDatum: 'GND',
                        },
                    },
                    geometry: {
                        type: 'Polygon',
                        coordinates: [
                            [
                                [133.6638888888889, 36.38444444444444],
                                [133.6638888888889, 36.20666666666667],
                                [132.83944444444447, 35.87972222222222],
                                [132.76333333333332, 36.265],
                                [132.67749999999998, 36.52055555555555],
                                [133.6638888888889, 36.38444444444444],
                            ],
                        ],
                    },
                },
                {
                    type: 'Feature',
                    properties: {
                        name: 'TMP JSDF X-16 till 31Mar22 Height by NOTAM',
                        class: 'R',
                        upperCeiling: {
                            value: 240,
                            unit: 'FL',
                            referenceDatum: 'STD',
                        },
                        lowerCeiling: {
                            value: 0,
                            unit: 'FT',
                            referenceDatum: 'GND',
                        },
                    },
                    geometry: {
                        type: 'Polygon',
                        coordinates: [
                            [
                                [129.92, 34.41972222222222],
                                [129.36444444444444, 33.836666666666666],
                                [128.99777777777777, 34.003055555555555],
                                [129.80333333333334, 34.55027777777777],
                                [129.86277777777778, 34.50277777777778],
                                [129.92, 34.41972222222222],
                            ],
                        ],
                    },
                },
                {
                    type: 'Feature',
                    properties: {
                        name: 'TMP Iwakuni ITRA-N2 and ITRA-N3 till 31Mar2022',
                        class: 'R',
                        upperCeiling: {
                            value: 240,
                            unit: 'FL',
                            referenceDatum: 'STD',
                        },
                        lowerCeiling: {
                            value: 0,
                            unit: 'FT',
                            referenceDatum: 'GND',
                        },
                    },
                    geometry: {
                        type: 'Polygon',
                        coordinates: [
                            [
                                [132.26527777777778, 35.32694444444445],
                                [132.3138888888889, 35.30138888888889],
                                [132.33722222222224, 35.29194444444444],
                                [131.9897222222222, 35.0375],
                                [131.9906522804197, 35.034102738438094],
                                [131.95822408370213, 35.027728618347524],
                                [131.89080456497356, 35.01170693847347],
                                [131.8247765242749, 34.9922142796155],
                                [131.7604076407297, 34.9693300170814],
                                [131.69795821678292, 34.94314726153926],
                                [131.6376800493862, 34.91377244476551],
                                [131.57981535096593, 34.88132484791109],
                                [131.5245957258126, 34.84593607506588],
                                [131.47224120697464, 34.807749475181076],
                                [131.42295935814894, 34.766919515655985],
                                [131.37694444444443, 34.72361111111112],
                                [130.88083333333333, 34.686388888888885],
                                [130.86694444444444, 34.72527777777778],
                                [130.585, 34.85305555555556],
                                [130.53083333333333, 34.76972222222222],
                                [130.03111111111113, 34.99527777777778],
                                [130.18916666666667, 35.11638888888889],
                                [132.26527777777778, 35.32694444444445],
                            ],
                        ],
                    },
                },
                {
                    type: 'Feature',
                    properties: {
                        name: 'Shizuhama TMP Training Area',
                        class: 'R',
                        upperCeiling: {
                            value: 11000,
                            unit: 'FT',
                            referenceDatum: 'MSL',
                        },
                        lowerCeiling: {
                            value: 6000,
                            unit: 'FT',
                            referenceDatum: 'MSL',
                        },
                    },
                    geometry: {
                        type: 'Polygon',
                        coordinates: [
                            [
                                [138.69194444444446, 35.14111111111111],
                                [138.58027777777778, 35.13666666666666],
                                [138.23722222222221, 35.05166666666666],
                                [138.26527777777778, 34.93111111111111],
                                [138.38111111111112, 34.868611111111115],
                                [138.7802777777778, 34.84166666666667],
                                [138.7802777777778, 34.876666666666665],
                                [138.69194444444446, 35.14111111111111],
                            ],
                        ],
                    },
                },
                {
                    type: 'Feature',
                    properties: {
                        name: 'Shizuhama TMP Training Area',
                        class: 'R',
                        upperCeiling: {
                            value: 11000,
                            unit: 'FT',
                            referenceDatum: 'MSL',
                        },
                        lowerCeiling: {
                            value: 6000,
                            unit: 'FT',
                            referenceDatum: 'MSL',
                        },
                    },
                    geometry: {
                        type: 'Polygon',
                        coordinates: [
                            [
                                [138.69194444444446, 35.14111111111111],
                                [138.58027777777778, 35.13666666666666],
                                [138.23722222222221, 35.05166666666666],
                                [138.26527777777778, 34.93111111111111],
                                [138.38111111111112, 34.868611111111115],
                                [138.7802777777778, 34.84166666666667],
                                [138.7802777777778, 34.876666666666665],
                                [138.69194444444446, 35.14111111111111],
                            ],
                        ],
                    },
                },
                {
                    type: 'Feature',
                    properties: {
                        name: 'Shizuhama TMP Training Area',
                        class: 'R',
                        upperCeiling: {
                            value: 11000,
                            unit: 'FT',
                            referenceDatum: 'MSL',
                        },
                        lowerCeiling: {
                            value: 6000,
                            unit: 'FT',
                            referenceDatum: 'MSL',
                        },
                    },
                    geometry: {
                        type: 'Polygon',
                        coordinates: [
                            [
                                [138.69194444444446, 35.14111111111111],
                                [138.58027777777778, 35.13666666666666],
                                [138.23722222222221, 35.05166666666666],
                                [138.26527777777778, 34.93111111111111],
                                [138.38111111111112, 34.868611111111115],
                                [138.7802777777778, 34.84166666666667],
                                [138.7802777777778, 34.876666666666665],
                                [138.69194444444446, 35.14111111111111],
                            ],
                        ],
                    },
                },
            ],
        };
        // remove feature id for comparison
        geojson.features.map((value) => delete value.id);

        expect(geojson).toEqual(expectedJson);
    });
});

describe('test optional configuration parameters', () => {
    test('do not round altitude value', async () => {
        const openairParser = new Parser();
        await openairParser.parse('./tests/fixtures/round-altitude-values.txt');
        const geojson = openairParser.toGeojson();

        const expectedJson = {
            type: 'FeatureCollection',
            features: [
                {
                    type: 'Feature',
                    properties: {
                        name: '22 Nord',
                        class: 'W',
                        upperCeiling: {
                            value: 90,
                            unit: 'FL',
                            referenceDatum: 'STD',
                        },
                        lowerCeiling: {
                            value: 1607.611551,
                            unit: 'FT',
                            referenceDatum: 'MSL',
                        },
                    },
                    geometry: {
                        type: 'Polygon',
                        coordinates: [
                            [
                                [16.25027777777778, 58.49305555555556],
                                [16.42361111111111, 58.47805555555556],
                                [16.504166666666666, 58.37388888888889],
                                [16.2575, 58.35277777777778],
                                [16.25027777777778, 58.49305555555556],
                            ],
                        ],
                    },
                },
            ],
        };
        // remove feature id for comparison
        geojson.features.map((value) => delete value.id);

        expect(geojson).toEqual(expectedJson);
    });
    test('round altitude value', async () => {
        const openairParser = new Parser({ roundAltValues: true });
        await openairParser.parse('./tests/fixtures/round-altitude-values.txt');
        const geojson = openairParser.toGeojson();

        const expectedJson = {
            type: 'FeatureCollection',
            features: [
                {
                    type: 'Feature',
                    properties: {
                        name: '22 Nord',
                        class: 'W',
                        upperCeiling: {
                            value: 90,
                            unit: 'FL',
                            referenceDatum: 'STD',
                        },
                        lowerCeiling: {
                            value: 1608,
                            unit: 'FT',
                            referenceDatum: 'MSL',
                        },
                    },
                    geometry: {
                        type: 'Polygon',
                        coordinates: [
                            [
                                [16.25027777777778, 58.49305555555556],
                                [16.42361111111111, 58.47805555555556],
                                [16.504166666666666, 58.37388888888889],
                                [16.2575, 58.35277777777778],
                                [16.25027777777778, 58.49305555555556],
                            ],
                        ],
                    },
                },
            ],
        };
        // remove feature id for comparison
        geojson.features.map((value) => delete value.id);

        expect(geojson).toEqual(expectedJson);
    });
    test('use default altitude unit', async () => {
        const openairParser = new Parser({ defaultAltUnit: 'm', targetAltUnit: 'm' });
        await openairParser.parse('./tests/fixtures/use-default-altitude-unit.txt');
        const geojson = openairParser.toGeojson();

        const expectedJson = {
            type: 'FeatureCollection',
            features: [
                {
                    type: 'Feature',
                    properties: {
                        name: '22 Nord',
                        class: 'W',
                        upperCeiling: {
                            value: 90,
                            unit: 'FL',
                            referenceDatum: 'STD',
                        },
                        lowerCeiling: {
                            value: 1607.611551,
                            unit: 'M',
                            referenceDatum: 'MSL',
                        },
                    },
                    geometry: {
                        type: 'Polygon',
                        coordinates: [
                            [
                                [16.25027777777778, 58.49305555555556],
                                [16.42361111111111, 58.47805555555556],
                                [16.504166666666666, 58.37388888888889],
                                [16.2575, 58.35277777777778],
                                [16.25027777777778, 58.49305555555556],
                            ],
                        ],
                    },
                },
            ],
        };
        // remove feature id for comparison
        geojson.features.map((value) => delete value.id);

        expect(geojson).toEqual(expectedJson);
    });
    test('correct limit validation when converting from ft to m', async () => {
        const openairParser = new Parser({ defaultAltUnit: 'ft', targetAltUnit: 'm' });
        await openairParser.parse('./tests/fixtures/check-limits-unit-conversion.txt');
        const geojson = openairParser.toGeojson();
        // remove feature id for comparison
        geojson.features.map((value) => delete value.id);

        expect(geojson).toEqual({
            type: 'FeatureCollection',
            features: [
                {
                    type: 'Feature',
                    properties: {
                        name: 'R3804C BY NOTAM',
                        class: 'R',
                        upperCeiling: {
                            value: 10667.99965862401,
                            unit: 'M',
                            referenceDatum: 'MSL',
                        },
                        lowerCeiling: {
                            value: 180,
                            unit: 'FL',
                            referenceDatum: 'STD',
                        },
                    },
                    geometry: {
                        type: 'Polygon',
                        coordinates: [
                            [
                                [-93.13666666666667, 31.014722222222222],
                                [-92.94805555555556, 31.014722222222222],
                                [-92.93722222222223, 31.005555555555556],
                                [-92.9063888888889, 31.005555555555556],
                                [-92.85944444444443, 31.06527777777778],
                                [-92.97361111111111, 31.15972222222222],
                                [-93.01555555555555, 31.15972222222222],
                                [-93.03194444444445, 31.14527777777778],
                                [-93.13666666666667, 31.14527777777778],
                                [-93.13666666666667, 31.014722222222222],
                            ],
                        ],
                    },
                },
            ],
        });
    });
});

describe('test parse invalid airspace definition blocks', () => {
    test('airspace with invalid coordinates', async () => {
        const openairParser = new Parser();

        await expect(openairParser.parse('./tests/fixtures/invalid-coordinates-airspace.txt')).rejects.toThrow(
            "Error found at line 14: Error found at line 14: Unknown coordinate definition 'DP 45:49:51 N 008:42:'"
        );
    });
    test('airspace with intersection', async () => {
        const openairParser = new Parser();

        await expect(openairParser.parse('./tests/fixtures/self-intersecting-airspace.txt')).rejects.toThrow(
            "Error found at line 1: Geometry of airspace 'TMA MILANO SWISS SEC1' starting on line 1 is invalid due to a self intersection"
        );
    });
    test('airspace with insufficient coordinates fails even if fix geometry is set', async () => {
        const openairParser = new Parser({ fixGeometry: true });

        await expect(openairParser.parse('./tests/fixtures/insufficient-coordinates-airspace.txt')).rejects.toThrow(
            "Error found at line 1: Geometry of airspace 'CTR TOO-FEW-POINTS' starting on line 1 has insufficient number of coordinates: 3"
        );
    });
    test('airspace with invalid geometry with self intersection can be fixed', async () => {
        const openairParser = new Parser({ fixGeometry: true });
        await openairParser.parse('./tests/fixtures/self-intersecting-airspace.txt');

        expect(() => {
            openairParser.toGeojson();
        }).not.toThrow();
    });
    test('airspace with invalid geometry with self intersection passes if not validated', async () => {
        const openairParser = new Parser({ fixGeometry: false, validateGeometry: false });
        await openairParser.parse('./tests/fixtures/circular-invalid-airspace.txt');
        const geojson = openairParser.toGeojson();

        const expectedJson = {
            type: 'FeatureCollection',
            features: [
                {
                    type: 'Feature',
                    properties: {
                        name: 'ED-R4 Wannsee H24',
                        class: 'R',
                        upperCeiling: {
                            value: 2200,
                            unit: 'FT',
                            referenceDatum: 'MSL',
                        },
                        lowerCeiling: {
                            value: 0,
                            unit: 'FT',
                            referenceDatum: 'GND',
                        },
                    },
                    geometry: {
                        type: 'Polygon',
                        coordinates: [
                            [
                                [13.1375, 52.3775],
                                [13.137500000000003, 52.377500000000005],
                                [13.134084067230118, 52.37725663365221],
                                [13.130649865341088, 52.377144584266844],
                                [13.127210916986305, 52.37716429305167],
                                [13.12378076338179, 52.37731568240125],
                                [13.120372911348609, 52.377598156200435],
                                [13.117000780486123, 52.37801060215574],
                                [13.113677650677065, 52.37855139614575],
                                [13.110416610124268, 52.37921840857398],
                                [13.107230504117156, 52.38000901269997],
                                [13.104131884723595, 52.38092009491697],
                                [13.101132961599593, 52.38194806693703],
                                [13.098245554105528, 52.38308887983683],
                                [13.095481044913097, 52.38433803991106],
                                [13.092850335282149, 52.38569062627216],
                                [13.090363802180713, 52.387141310129714],
                                [13.08803125741519, 52.38868437567502],
                                [13.085861908930717, 52.39031374249125],
                                [13.083864324433948, 52.39202298940263],
                                [13.08204639748246, 52.393805379671164],
                                [13.080415316176046, 52.39565388744344],
                                [13.078977534575916, 52.39756122534567],
                                [13.0777387469679, 52.39951987311996],
                                [13.076703865075316, 52.401522107190644],
                                [13.075876998316438, 52.40356003104609],
                                [13.075261437189976, 52.40562560631734],
                                [13.074859639860442, 52.40771068443251],
                                [13.074673222003018, 52.40980703872298],
                                [13.074702949955135, 52.41190639685556],
                                [13.074948737209253, 52.4140004734632],
                                [13.075409644268253, 52.416081002845736],
                                [13.07608388187172, 52.41813977161164],
                                [13.076968817587904, 52.42016865113139],
                                [13.078060985752904, 52.42215962967424],
                                [13.079356100724818, 52.42410484410022],
                                [13.08084907340737, 52.42599661098137],
                                [13.082534030983956, 52.42782745702801],
                                [13.084404339789765, 52.429590148698175],
                                [13.086452631236657, 52.431277720871805],
                                [13.088670830692438, 52.43288350447418],
                                [13.091050189203902, 52.43440115293777],
                                [13.093581317940671, 52.435824667395686],
                                [13.096254225225309, 52.43714842050491],
                                [13.099058356003981, 52.438367178803084],
                                [13.101982633601292, 52.43947612350817],
                                [13.10501550359299, 52.440470869676766],
                                [13.108144979620922, 52.4413474836428],
                                [13.11135869096603, 52.44210249866637],
                                [13.114643931687416, 52.442732928728255],
                                [13.117987711128498, 52.44323628041438],
                                [13.12137680558527, 52.44361056284152],
                                [13.124797810926324, 52.44385429558378],
                                [13.128237195950215, 52.44396651456741],
                                [13.131681356262218, 52.44394677590994],
                                [13.135116668450467, 52.44379515768797],
                                [13.138529544339773, 52.443512259626075],
                                [13.141906485101396, 52.443099200708666],
                                [13.145234134997501, 52.44255761472392],
                                [13.148499334540686, 52.44188964375862],
                                [13.15168917285172, 52.441097929669965],
                                [13.154791039002065, 52.440185603569475],
                                [13.15779267213246, 52.439156273361974],
                                [13.160682210144197, 52.4380140093902],
                                [13.163448236766156, 52.43676332824378],
                                [13.16607982680787, 52.4354091747985],
                                [13.168566589416885, 52.43395690255866],
                                [13.170898709167503, 52.43241225238269],
                                [13.173066984817508, 52.430781329678],
                                [13.175062865579656, 52.42907058015761],
                                [13.176878484765421, 52.427286764256564],
                                [13.178506690669971, 52.42543693031131],
                                [13.179941074578963, 52.42352838661012],
                                [13.181175995790221, 52.421568672427064],
                                [13.182206603555793, 52.419565528155665],
                                [13.183028855862883, 52.41752686466191],
                                [13.183639534985332, 52.41546073197927],
                                [13.184036259750608, 52.41337528747034],
                                [13.184217494480746, 52.41127876358193],
                                [13.184182554579142, 52.40917943532192],
                                [13.184181160899863, 52.409159143027935],
                                [13.18388888888889, 52.409166666666664],
                                [13.1375, 52.3775],
                                [13.140833333333333, 52.385555555555555],
                                [13.1375, 52.3775],
                            ],
                        ],
                    },
                },
            ],
        };
        // remove feature id for comparison
        geojson.features.map((value) => delete value.id);

        expect(geojson).toEqual(expectedJson);
    });
    test('airspace with empty name', async () => {
        const openairParser = new Parser();

        await expect(openairParser.parse('./tests/fixtures/empty-name.txt')).rejects.toThrow(
            "Error found at line 3: Token 'AC' on line 1 does not allow subsequent token 'AH' on line 3"
        );
    });
    test('airspace with duplicate ceiling definitions are rejected', async () => {
        const openairParser = new Parser();

        await expect(openairParser.parse('./tests/fixtures/duplicate-ceiling-definitions.txt')).rejects.toThrow(
            "Error found at line 4: Token 'AL' on line 3 does not allow subsequent token 'AL' on line 4"
        );
    });
    test('airspace start and end coordinates are not equal', async () => {
        const openairParser = new Parser();

        await expect(
            openairParser.parse('./tests/fixtures/airspace-start-end-coordinates-not-equal.txt')
        ).rejects.toThrow(
            "Error found at line 2: Geometry of airspace 'RMZ Rochefort 119.3' starting on line 2 is invalid. First and last Position are not equivalent."
        );
    });
});

describe('test parse invalid airspace definition blocks and fix geometry', () => {
    test('airspace with invalid geometry with self intersection can be fixed and is not Multipolygon', async () => {
        const openairParser = new Parser({ fixGeometry: true });
        await openairParser.parse('./tests/fixtures/do-not-split-into-multipolygon.txt');
        const { features } = openairParser.toGeojson();
        const { geometry } = features[0];

        expect(geometry.type).toEqual('Polygon');
    });
    test('airspace fix start and end coordinates if not equal', async () => {
        const openairParser = new Parser({ fixGeometry: true });
        await openairParser.parse('./tests/fixtures/airspace-start-end-coordinates-not-equal.txt');
        const { features } = openairParser.toGeojson();
        const { geometry } = features[0];

        expect(geometry.type).toEqual('Polygon');
    });
});
